{% extends "base.html" %}
{% load static %}
{% block content %}


<div class="container-fluid mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 bg-dark text-light p-4 rounded">
            <div class="flex flex-col justify-center items-center space-y-4">
                <h1 class="text-2xl font-bold text-[#005CFF]">Nueva Solicitud</h1>
                {% if messages %}
                    <ul class="messages">
                        {% for message in messages %}
                            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <form id="dynamic-form" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="tipo_sol" class="form-label text-gray-400">Tipo de Solicitud:</label>
                        <select id="tipo_sol" name="tipo_sol" class="form-select w-100 mb-2 p-2 border border-1">
                            <option value="">--Seleccione--</option>
                            {% for form in formularios %}
                                <option value="{{form.prefix}}"
                                {% if tipo_form and tipo_form == form.prefix %}
                                selected
                                {% endif %}>{{form.prefix}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="campos-formulario" class="mb-3">
                        <!-- Aquí se insertarán los campos dinámicos -->
                    {% if current_form %}
                        {% for field in current_form %}
                            <div class="form-group">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}
                                    {% for error in field.errors %}
                                        <div class="alert alert-danger">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% endif %}
                    </div>
                    <button class="btn btn-primary w-full mt-4" type="submit">
                        <i class="fas fa-plus-circle mr-2"></i> Crear Solicitud
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById('tipo_sol').addEventListener('change', function() {
        var opcion = this.value;
        var camposForm = document.getElementById('campos-formulario');
        // Lógica para mostrar los campos adicionales según la opción seleccionada
        switch (opcion) {
            {% for form in formularios %}
            case "{{form.prefix}}":
                camposForm.innerHTML = {% spaceless %}'{{form}}'{% endspaceless %};
                break
            {% endfor %}
            default:
                camposForm.innerHTML = '';
                break;
        }

        //Ajustes para Formularios mas dinamicos
        //  - Servicio VPN (Rico desorden con tantos foreach XD)
        var selectorVpn = document.getElementById('id_Servicio VPN-accion')
        var camposVpn = document.querySelectorAll('[name^="Servicio VPN"]')
        camposVpn.forEach(campo => {
            if(!campo.parentElement.hidden && campo.tagName!=="SELECT"){
                campo.parentElement.hidden = true
            }
        });
        if (selectorVpn){
            selectorVpn.addEventListener('change', function() {        
                let tareaVpn = this.value
                let campo_fecha = document.querySelector('[name="Servicio VPN-fecha_expiracion"]')
                campo_fecha.required = true
                campo_fecha.disabled = false
                camposVpn.forEach(campo => {
                    if(campo.parentElement.hidden){
                        campo.parentElement.hidden = false
                    }
                });
                switch(tareaVpn) {
                    case "Nada":
                        //Esconder todo del formulario
                        camposVpn.forEach(campo => {
                            if(!campo.parentElement.hidden && campo.tagName!=="SELECT"){
                                campo.parentElement.hidden = true
                            }
                        });
                        break
                    case "Extension de cuenta":
                    //No hacemos nada, de paso para evitar algun bug
                        break
                    default:
                        //Esconder el campo de fecha de expiracion y hacerlo no necesario por temas de javascript
                        if(!campo_fecha.parentElement.hidden){
                            campo_fecha.parentElement.hidden = true
                        }
                        campo_fecha.required = false
                        campo_fecha.disabled = true
                        break
                }
                }
            )
        }

    });

    
</script>
{% endblock %}


